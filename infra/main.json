{
  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
  "contentVersion": "1.0.0.0",
  "metadata": {
    "_generator": {
      "name": "bicep",
      "version": "0.39.26.7824",
      "templateHash": "2917686305631787529"
    }
  },
  "parameters": {
    "location": {
      "type": "string",
      "defaultValue": "swedencentral",
      "allowedValues": [
        "swedencentral"
      ],
      "metadata": {
        "description": "Deployment location"
      }
    },
    "environmentName": {
      "type": "string",
      "defaultValue": "dev",
      "metadata": {
        "description": "Environment name for resource naming"
      }
    },
    "containerImageName": {
      "type": "string",
      "defaultValue": "zavastorefront:dev",
      "metadata": {
        "description": "Container image name with tag stored in ACR"
      }
    },
    "acrName": {
      "type": "string",
      "defaultValue": "[format('acrzava{0}', uniqueString(resourceGroup().id))]",
      "metadata": {
        "description": "Azure Container Registry name"
      }
    },
    "appServicePlanName": {
      "type": "string",
      "defaultValue": "[format('asp-zava-{0}-{1}', parameters('environmentName'), uniqueString(resourceGroup().id))]",
      "metadata": {
        "description": "App Service plan name"
      }
    },
    "webAppName": {
      "type": "string",
      "defaultValue": "[format('app-zava-{0}-{1}', parameters('environmentName'), uniqueString(resourceGroup().id))]",
      "metadata": {
        "description": "Web App name"
      }
    },
    "logAnalyticsName": {
      "type": "string",
      "defaultValue": "[format('log-zava-{0}-{1}', parameters('environmentName'), uniqueString(resourceGroup().id))]",
      "metadata": {
        "description": "Log Analytics workspace name"
      }
    },
    "appInsightsName": {
      "type": "string",
      "defaultValue": "[format('appi-zava-{0}-{1}', parameters('environmentName'), uniqueString(resourceGroup().id))]",
      "metadata": {
        "description": "Application Insights name"
      }
    },
    "foundryAccountName": {
      "type": "string",
      "defaultValue": "[format('aizava{0}', toLower(uniqueString(resourceGroup().id)))]",
      "metadata": {
        "description": "Microsoft Foundry (Azure OpenAI) account name"
      }
    },
    "gptDeploymentName": {
      "type": "string",
      "defaultValue": "gpt4",
      "metadata": {
        "description": "GPT-4 deployment name"
      }
    },
    "phiDeploymentName": {
      "type": "string",
      "defaultValue": "phi",
      "metadata": {
        "description": "Phi deployment name"
      }
    },
    "gptModelName": {
      "type": "string",
      "defaultValue": "gpt-4",
      "metadata": {
        "description": "GPT-4 model name"
      }
    },
    "gptModelVersion": {
      "type": "string",
      "defaultValue": "0613",
      "metadata": {
        "description": "GPT-4 model version (update if swedencentral requires a different version)"
      }
    },
    "phiModelName": {
      "type": "string",
      "defaultValue": "phi-4",
      "metadata": {
        "description": "Phi model name"
      }
    },
    "phiModelVersion": {
      "type": "string",
      "defaultValue": "2024-10-01",
      "metadata": {
        "description": "Phi model version (update if swedencentral requires a different version)"
      }
    }
  },
  "resources": [
    {
      "type": "Microsoft.Authorization/roleAssignments",
      "apiVersion": "2022-04-01",
      "scope": "[format('Microsoft.ContainerRegistry/registries/{0}', parameters('acrName'))]",
      "name": "[guid(resourceGroup().id, parameters('webAppName'), parameters('acrName'), 'acrpull')]",
      "properties": {
        "roleDefinitionId": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', '7f951dda-4ed3-4680-a7ca-43fe172d538d')]",
        "principalId": "[reference(resourceId('Microsoft.Resources/deployments', 'appService'), '2025-04-01').outputs.webAppPrincipalId.value]",
        "principalType": "ServicePrincipal"
      },
      "dependsOn": [
        "[resourceId('Microsoft.Resources/deployments', 'appService')]"
      ]
    },
    {
      "type": "Microsoft.Authorization/roleAssignments",
      "apiVersion": "2022-04-01",
      "scope": "[format('Microsoft.CognitiveServices/accounts/{0}', parameters('foundryAccountName'))]",
      "name": "[guid(resourceGroup().id, parameters('webAppName'), parameters('foundryAccountName'), 'foundryuser')]",
      "properties": {
        "roleDefinitionId": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', 'a97b65f3-24c7-4388-baec-2e87135dc908')]",
        "principalId": "[reference(resourceId('Microsoft.Resources/deployments', 'appService'), '2025-04-01').outputs.webAppPrincipalId.value]",
        "principalType": "ServicePrincipal"
      },
      "dependsOn": [
        "[resourceId('Microsoft.Resources/deployments', 'appService')]"
      ]
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "acr",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "acrName": {
            "value": "[parameters('acrName')]"
          },
          "location": {
            "value": "[parameters('location')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.39.26.7824",
              "templateHash": "12469866283275461567"
            }
          },
          "parameters": {
            "acrName": {
              "type": "string",
              "metadata": {
                "description": "Azure Container Registry name"
              }
            },
            "location": {
              "type": "string",
              "metadata": {
                "description": "Location for the registry"
              }
            }
          },
          "resources": [
            {
              "type": "Microsoft.ContainerRegistry/registries",
              "apiVersion": "2023-01-01-preview",
              "name": "[parameters('acrName')]",
              "location": "[parameters('location')]",
              "sku": {
                "name": "Basic"
              },
              "properties": {
                "adminUserEnabled": false
              }
            }
          ],
          "outputs": {
            "acrId": {
              "type": "string",
              "value": "[resourceId('Microsoft.ContainerRegistry/registries', parameters('acrName'))]"
            },
            "acrLoginServer": {
              "type": "string",
              "value": "[reference(resourceId('Microsoft.ContainerRegistry/registries', parameters('acrName')), '2023-01-01-preview').loginServer]"
            }
          }
        }
      }
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "logAnalytics",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "workspaceName": {
            "value": "[parameters('logAnalyticsName')]"
          },
          "location": {
            "value": "[parameters('location')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.39.26.7824",
              "templateHash": "16844759748434170435"
            }
          },
          "parameters": {
            "workspaceName": {
              "type": "string",
              "metadata": {
                "description": "Log Analytics workspace name"
              }
            },
            "location": {
              "type": "string",
              "metadata": {
                "description": "Location for Log Analytics workspace"
              }
            }
          },
          "resources": [
            {
              "type": "Microsoft.OperationalInsights/workspaces",
              "apiVersion": "2023-09-01",
              "name": "[parameters('workspaceName')]",
              "location": "[parameters('location')]",
              "properties": {
                "sku": {
                  "name": "PerGB2018"
                },
                "retentionInDays": 30
              }
            }
          ],
          "outputs": {
            "workspaceId": {
              "type": "string",
              "value": "[resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspaceName'))]"
            },
            "workspaceName": {
              "type": "string",
              "value": "[parameters('workspaceName')]"
            },
            "workspaceCustomerId": {
              "type": "string",
              "value": "[reference(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspaceName')), '2023-09-01').customerId]"
            }
          }
        }
      }
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "appInsights",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "appInsightsName": {
            "value": "[parameters('appInsightsName')]"
          },
          "location": {
            "value": "[parameters('location')]"
          },
          "logAnalyticsWorkspaceId": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', 'logAnalytics'), '2025-04-01').outputs.workspaceId.value]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.39.26.7824",
              "templateHash": "15366509045935505655"
            }
          },
          "parameters": {
            "appInsightsName": {
              "type": "string",
              "metadata": {
                "description": "Application Insights name"
              }
            },
            "location": {
              "type": "string",
              "metadata": {
                "description": "Location for Application Insights"
              }
            },
            "logAnalyticsWorkspaceId": {
              "type": "string",
              "metadata": {
                "description": "Log Analytics workspace resource ID"
              }
            }
          },
          "resources": [
            {
              "type": "Microsoft.Insights/components",
              "apiVersion": "2020-02-02",
              "name": "[parameters('appInsightsName')]",
              "location": "[parameters('location')]",
              "kind": "web",
              "properties": {
                "Application_Type": "web",
                "WorkspaceResourceId": "[parameters('logAnalyticsWorkspaceId')]"
              }
            }
          ],
          "outputs": {
            "appInsightsId": {
              "type": "string",
              "value": "[resourceId('Microsoft.Insights/components', parameters('appInsightsName'))]"
            },
            "appInsightsName": {
              "type": "string",
              "value": "[parameters('appInsightsName')]"
            },
            "appInsightsConnectionString": {
              "type": "string",
              "value": "[reference(resourceId('Microsoft.Insights/components', parameters('appInsightsName')), '2020-02-02').ConnectionString]"
            }
          }
        }
      },
      "dependsOn": [
        "[resourceId('Microsoft.Resources/deployments', 'logAnalytics')]"
      ]
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "appService",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "appServicePlanName": {
            "value": "[parameters('appServicePlanName')]"
          },
          "webAppName": {
            "value": "[parameters('webAppName')]"
          },
          "location": {
            "value": "[parameters('location')]"
          },
          "acrLoginServer": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', 'acr'), '2025-04-01').outputs.acrLoginServer.value]"
          },
          "containerImageName": {
            "value": "[parameters('containerImageName')]"
          },
          "appInsightsConnectionString": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', 'appInsights'), '2025-04-01').outputs.appInsightsConnectionString.value]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.39.26.7824",
              "templateHash": "15384861315296853921"
            }
          },
          "parameters": {
            "appServicePlanName": {
              "type": "string",
              "metadata": {
                "description": "App Service plan name"
              }
            },
            "webAppName": {
              "type": "string",
              "metadata": {
                "description": "Web App name"
              }
            },
            "location": {
              "type": "string",
              "metadata": {
                "description": "Location for App Service resources"
              }
            },
            "acrLoginServer": {
              "type": "string",
              "metadata": {
                "description": "ACR login server (e.g. myregistry.azurecr.io)"
              }
            },
            "containerImageName": {
              "type": "string",
              "metadata": {
                "description": "Container image name with tag, e.g. zavastorefront:dev"
              }
            },
            "appInsightsConnectionString": {
              "type": "string",
              "metadata": {
                "description": "Application Insights connection string"
              }
            }
          },
          "resources": [
            {
              "type": "Microsoft.Web/serverfarms",
              "apiVersion": "2022-09-01",
              "name": "[parameters('appServicePlanName')]",
              "location": "[parameters('location')]",
              "sku": {
                "name": "B1",
                "tier": "Basic",
                "size": "B1",
                "capacity": 1
              },
              "kind": "linux",
              "properties": {
                "reserved": true
              }
            },
            {
              "type": "Microsoft.Web/sites",
              "apiVersion": "2022-09-01",
              "name": "[parameters('webAppName')]",
              "location": "[parameters('location')]",
              "kind": "app,linux,container",
              "identity": {
                "type": "SystemAssigned"
              },
              "properties": {
                "serverFarmId": "[resourceId('Microsoft.Web/serverfarms', parameters('appServicePlanName'))]",
                "httpsOnly": true,
                "siteConfig": {
                  "linuxFxVersion": "[format('DOCKER|{0}/{1}', parameters('acrLoginServer'), parameters('containerImageName'))]",
                  "acrUseManagedIdentityCreds": true,
                  "appSettings": [
                    {
                      "name": "APPLICATIONINSIGHTS_CONNECTION_STRING",
                      "value": "[parameters('appInsightsConnectionString')]"
                    },
                    {
                      "name": "ApplicationInsightsAgent_EXTENSION_VERSION",
                      "value": "~3"
                    },
                    {
                      "name": "WEBSITES_PORT",
                      "value": "8080"
                    }
                  ]
                }
              },
              "dependsOn": [
                "[resourceId('Microsoft.Web/serverfarms', parameters('appServicePlanName'))]"
              ]
            }
          ],
          "outputs": {
            "webAppId": {
              "type": "string",
              "value": "[resourceId('Microsoft.Web/sites', parameters('webAppName'))]"
            },
            "webAppName": {
              "type": "string",
              "value": "[parameters('webAppName')]"
            },
            "webAppPrincipalId": {
              "type": "string",
              "value": "[reference(resourceId('Microsoft.Web/sites', parameters('webAppName')), '2022-09-01', 'full').identity.principalId]"
            }
          }
        }
      },
      "dependsOn": [
        "[resourceId('Microsoft.Resources/deployments', 'acr')]",
        "[resourceId('Microsoft.Resources/deployments', 'appInsights')]"
      ]
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "foundry",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "foundryAccountName": {
            "value": "[parameters('foundryAccountName')]"
          },
          "location": {
            "value": "[parameters('location')]"
          },
          "gptDeploymentName": {
            "value": "[parameters('gptDeploymentName')]"
          },
          "phiDeploymentName": {
            "value": "[parameters('phiDeploymentName')]"
          },
          "gptModelName": {
            "value": "[parameters('gptModelName')]"
          },
          "gptModelVersion": {
            "value": "[parameters('gptModelVersion')]"
          },
          "phiModelName": {
            "value": "[parameters('phiModelName')]"
          },
          "phiModelVersion": {
            "value": "[parameters('phiModelVersion')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.39.26.7824",
              "templateHash": "16039803677908485125"
            }
          },
          "parameters": {
            "foundryAccountName": {
              "type": "string",
              "metadata": {
                "description": "Microsoft Foundry (Azure OpenAI) account name"
              }
            },
            "location": {
              "type": "string",
              "metadata": {
                "description": "Location for the Foundry account"
              }
            },
            "gptDeploymentName": {
              "type": "string",
              "metadata": {
                "description": "Deployment name for GPT-4 model"
              }
            },
            "phiDeploymentName": {
              "type": "string",
              "metadata": {
                "description": "Deployment name for Phi model"
              }
            },
            "gptModelName": {
              "type": "string",
              "metadata": {
                "description": "GPT-4 model name (e.g. gpt-4)"
              }
            },
            "gptModelVersion": {
              "type": "string",
              "metadata": {
                "description": "GPT-4 model version"
              }
            },
            "phiModelName": {
              "type": "string",
              "metadata": {
                "description": "Phi model name (e.g. phi-4)"
              }
            },
            "phiModelVersion": {
              "type": "string",
              "metadata": {
                "description": "Phi model version"
              }
            }
          },
          "resources": [
            {
              "type": "Microsoft.CognitiveServices/accounts",
              "apiVersion": "2023-05-01",
              "name": "[parameters('foundryAccountName')]",
              "location": "[parameters('location')]",
              "kind": "OpenAI",
              "sku": {
                "name": "S0"
              },
              "properties": {
                "publicNetworkAccess": "Enabled",
                "disableLocalAuth": true
              }
            },
            {
              "type": "Microsoft.CognitiveServices/accounts/deployments",
              "apiVersion": "2023-05-01",
              "name": "[format('{0}/{1}', parameters('foundryAccountName'), parameters('gptDeploymentName'))]",
              "sku": {
                "name": "Standard",
                "capacity": 1
              },
              "properties": {
                "model": {
                  "format": "OpenAI",
                  "name": "[parameters('gptModelName')]",
                  "version": "[parameters('gptModelVersion')]"
                },
                "raiPolicyName": "Microsoft.Default",
                "versionUpgradeOption": "OnceCurrentVersionExpired"
              },
              "dependsOn": [
                "[resourceId('Microsoft.CognitiveServices/accounts', parameters('foundryAccountName'))]"
              ]
            },
            {
              "type": "Microsoft.CognitiveServices/accounts/deployments",
              "apiVersion": "2023-05-01",
              "name": "[format('{0}/{1}', parameters('foundryAccountName'), parameters('phiDeploymentName'))]",
              "sku": {
                "name": "Standard",
                "capacity": 1
              },
              "properties": {
                "model": {
                  "format": "OpenAI",
                  "name": "[parameters('phiModelName')]",
                  "version": "[parameters('phiModelVersion')]"
                },
                "raiPolicyName": "Microsoft.Default",
                "versionUpgradeOption": "OnceCurrentVersionExpired"
              },
              "dependsOn": [
                "[resourceId('Microsoft.CognitiveServices/accounts', parameters('foundryAccountName'))]"
              ]
            }
          ],
          "outputs": {
            "foundryAccountId": {
              "type": "string",
              "value": "[resourceId('Microsoft.CognitiveServices/accounts', parameters('foundryAccountName'))]"
            },
            "foundryAccountName": {
              "type": "string",
              "value": "[parameters('foundryAccountName')]"
            },
            "foundryEndpoint": {
              "type": "string",
              "value": "[reference(resourceId('Microsoft.CognitiveServices/accounts', parameters('foundryAccountName')), '2023-05-01').endpoint]"
            }
          }
        }
      }
    }
  ],
  "outputs": {
    "acrLoginServer": {
      "type": "string",
      "value": "[reference(resourceId('Microsoft.Resources/deployments', 'acr'), '2025-04-01').outputs.acrLoginServer.value]"
    },
    "webAppName": {
      "type": "string",
      "value": "[reference(resourceId('Microsoft.Resources/deployments', 'appService'), '2025-04-01').outputs.webAppName.value]"
    },
    "appInsightsName": {
      "type": "string",
      "value": "[reference(resourceId('Microsoft.Resources/deployments', 'appInsights'), '2025-04-01').outputs.appInsightsName.value]"
    },
    "foundryEndpoint": {
      "type": "string",
      "value": "[reference(resourceId('Microsoft.Resources/deployments', 'foundry'), '2025-04-01').outputs.foundryEndpoint.value]"
    },
    "AZURE_WEBAPP_NAME": {
      "type": "string",
      "value": "[reference(resourceId('Microsoft.Resources/deployments', 'appService'), '2025-04-01').outputs.webAppName.value]"
    },
    "AZURE_CONTAINER_REGISTRY_NAME": {
      "type": "string",
      "value": "[parameters('acrName')]"
    },
    "AZURE_CONTAINER_REGISTRY_ENDPOINT": {
      "type": "string",
      "value": "[reference(resourceId('Microsoft.Resources/deployments', 'acr'), '2025-04-01').outputs.acrLoginServer.value]"
    },
    "APPLICATIONINSIGHTS_CONNECTION_STRING": {
      "type": "string",
      "value": "[reference(resourceId('Microsoft.Resources/deployments', 'appInsights'), '2025-04-01').outputs.appInsightsConnectionString.value]"
    }
  }
}